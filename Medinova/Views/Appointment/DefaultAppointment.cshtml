
<div class="container py-5" id="randevu">
    <div class="row align-items-center gx-5">

        <!-- LEFT / HERO -->
        <div class="col-lg-6 mb-5 mb-lg-0">
            <div class="mb-4">
                <h5 class="d-inline-block text-primary text-uppercase border-bottom border-5">
                    Randevu
                </h5>
                <h1 class="display-4 fw-bold text-dark mt-3">
                    Aileniz için <br />Randevu alabilirsiniz
                </h1>
            </div>

            <p class="text-muted mb-4">
                Sağlığınız bizim için önemli. Uzman doktorlarımızdan hızlı ve kolay
                şekilde randevu alabilir, şikayetlerinize göre doğru bölüme yönlendirilebilirsiniz.
            </p>

            <div class="d-flex gap-3">
                <a class="btn btn-dark rounded-pill py-3 px-5" href="#appointmentForm">
                    Doctor Bul
                </a>
                <a class="btn btn-outline-dark rounded-pill py-3 px-5" href="/Default/About">
                    Daha Fazlası
                </a>
            </div>
        </div>

        <!-- RIGHT / FORM -->
        <div class="col-lg-6">
            <div class="bg-white rounded-4 shadow p-5">
                <h2 class="text-center fw-bold mb-4">
                    Randevu Al
                </h2>

                <form method="post" action="/Appointment/MakeAppointment" id="appointmentForm">
                    @Html.AntiForgeryToken()

                    <div class="row g-3">

                        <!-- Department -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Bölüm Seçiniz</label>
                            @Html.DropDownList(
                                "DepartmentId",
                                (List<SelectListItem>)ViewBag.departments,
                                "--- Bölüm Seçiniz ---",
                                new { @class = "form-control bg-light border-0", style = "height:55px" })
                        </div>

                        <!-- Doctor -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Doktor Seçiniz</label>
                            <select id="DoctorId" name="DoctorId"
                                    class="form-control bg-light border-0"
                                    style="height:55px">
                                <option selected>--- Önce Bölümü Seçiniz ---</option>
                            </select>
                        </div>

                        <!-- Complaint -->
                        <div class="col-12">
                            <label class="form-label fw-semibold">Şikayetiniz</label>
                            <textarea id="ComplaintText"
                                      name="ComplaintText"
                                      class="form-control bg-light border-0"
                                      rows="3"
                                      placeholder="Şikayetinizi yazın (örn: baş ağrısı, mide bulantısı)"></textarea>

                            <div class="d-flex align-items-center gap-2 mt-2">
                                <button type="button"
                                        id="getDepartmentSuggestion"
                                        class="btn btn-outline-primary btn-sm">
                                    Bölüm Öner
                                </button>
                                <small id="departmentSuggestionResult" class="text-muted"></small>
                            </div>
                        </div>

                        <!-- Name -->
                        <div class="col-md-6">
                            <input type="text"
                                   name="FullName"
                                   class="form-control bg-light border-0"
                                   placeholder="Adınız Soyadınız"
                                   style="height:55px">
                        </div>

                        <!-- Email -->
                        <div class="col-md-6">
                            <input type="email"
                                   name="Email"
                                   class="form-control bg-light border-0"
                                   placeholder="Email Adresiniz"
                                   style="height:55px">
                        </div>

                        <!-- Phone -->
                        <div class="col-md-6">
                            <input type="text"
                                   name="PhoneNumber"
                                   class="form-control bg-light border-0"
                                   placeholder="Telefon Numaranız"
                                   style="height:55px">
                        </div>

                        <!-- Date -->
                        <div class="col-md-6">
                            @Html.DropDownList(
                                "AppointmentDate",
                                (List<SelectListItem>)ViewBag.dateList,
                                "--- Tarih Seçiniz ---",
                                new { @class = "form-control bg-light border-0", style = "height:55px" })
                        </div>

                        <!-- Time -->
                        <div class="col-12">
                            <select id="AppointmentTime"
                                    name="AppointmentTime"
                                    class="form-control bg-light border-0"
                                    style="height:55px">
                                <option selected>--- Önce Tarih Seçiniz ---</option>
                            </select>
                        </div>

                        <!-- Submit -->
                        <div class="col-12 mt-3">
                            <button class="btn btn-primary w-100 py-3 fw-semibold" type="submit">
                                Randevu Oluştur
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var isAuthenticated = @((Session["userId"] != null).ToString().ToLower());

        $("#appointmentForm").on("submit", function (event) {
            if (!isAuthenticated) {
                event.preventDefault();
                Swal.fire({
                    icon: "warning",
                    title: "Giriş gerekli",
                    text: "Randevu almak için önce giriş yapmalısınız.",
                    confirmButtonText: "Girişe git"
                }).then(function () {
                    window.location.href = "/Account/Login";
                });
            }
        });
        $("#getDepartmentSuggestion").on("click", function () {
            var complaintText = $("#ComplaintText").val().trim();
            var suggestionResult = $("#departmentSuggestionResult");

            if (!complaintText) {
                suggestionResult.text("Lütfen önce şikayetinizi yazın.");
                return;
            }

            suggestionResult.html('<span class="spinner-border spinner-border-sm"></span> Öneri alınıyor...');

            $.ajax({
                url: '/Patient/AIAssistant/GetDepartmentSuggestion',
                type: 'POST',
                dataType: 'json',
                data: { symptoms: complaintText },
                success: function (result) {
                    if (result.success) {
                        var recommendation = result.recommendation || "";
                        suggestionResult.text("Önerilen bölüm: " + recommendation);
                        preselectDepartment(recommendation);
                    } else {
                        suggestionResult.text("Öneri alınamadı: " + result.message);
                    }
                },
                error: function () {
                    suggestionResult.text("Öneri alınırken hata oluştu.");
                }
            });
        });
        $("#DepartmentId").change(function () {

            var selectedDepId = $(this).val();

            var doctorDropdown = $("#DoctorId");



            $('#AppointmentDate').val('').trigger('change');
            $('#AppointmentTime').val('').trigger('change');


            $.ajax({
                url: '/Appointment/GetDoctorsByDepartmentId',
                type: 'GET',
                data: { departmentId: selectedDepId },
                dataType: 'json',
                success: function (data) {
                    doctorDropdown.empty();


                    $.each(data, function (i, doctor) {

                        doctorDropdown.append($('<option> </option>').val(doctor.Value).html(doctor.Text));
                    });
                }
            })

        })

        $("#AppointmentDate").change(function () {

            var selectedDate = $(this).val();

            var selectedDoctorId = $("#DoctorId").val();

            var timeDropdown = $("#AppointmentTime");

            if (selectedDate === '' && selectedDoctorId === '') {
                timeDropdown.append('<option>---Önce Doktoru ve Tarihi Seçin</option>');
            }

            $.ajax({
                url: '/Appointment/GetAvailableHours',
                type: 'POST',
                dataType: 'json',
                data: { selectedDate: selectedDate, doctorId: selectedDoctorId },
                success: function (data) {

                    timeDropdown.empty();



                    $.each(data, function (i, item) {

                        var isDisabled = false;
                        var optionText = item.Time;

                        if (item.IsBooked) {
                            optionText += " (Dolu)";
                            isDisabled = true;
                        }

                        var option = $('<option> </option>').val(item.Time).html(optionText);

                        if (isDisabled) {
                            option.prop('disabled', true);
                        }

                        timeDropdown.append(option);
                        timeDropdown.prop('disabled', false);

                    });

                }
            });

        });
        function preselectDepartment(recommendation) {
            if (!recommendation) {
                return;
            }

            var normalizedRecommendation = recommendation.toLowerCase();
            var departmentDropdown = $("#DepartmentId");
            var matchedOption = null;

            departmentDropdown.find("option").each(function () {
                var optionText = $(this).text().toLowerCase();
                if (optionText === normalizedRecommendation || optionText.includes(normalizedRecommendation) || normalizedRecommendation.includes(optionText)) {
                    matchedOption = $(this);
                    return false;
                }
            });

            if (matchedOption && matchedOption.val()) {
                departmentDropdown.val(matchedOption.val()).trigger("change");
            }
        }

    });




</script>