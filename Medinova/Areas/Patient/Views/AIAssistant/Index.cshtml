@model IEnumerable<Medinova.Models.AIConversation>
@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Patient/Views/Shared/_PatientLayout.cshtml";
}

<div class="container-fluid py-4">
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI Sağlık Asistanı
                </h4>
            </div>
            <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatContainer">
                @if (Model.Any())
                {
                    foreach (var conv in Model.OrderBy(c => c.CreatedDate))
                    {
                        <div class="mb-3">
                            <div class="bg-light p-3 rounded">
                                <strong>Siz:</strong> @conv.UserMessage
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded mt-2">
                                <strong>AI:</strong> @conv.AIResponse
                            </div>
                            <small class="text-muted">@conv.CreatedDate.ToString("dd MMM HH:mm")</small>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Henüz sohbet başlatılmadı. Aşağıdaki kutuya sorunuzu yazın.</p>
                    </div>
                }
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="questionInput" class="form-control"
                           placeholder="Sorunuzu yazın... (örn: Boynum ağrıyor ne yapabilirim?)">
                    <button class="btn btn-primary" onclick="askQuestion()">
                        <i class="fas fa-paper-plane"></i> Gönder
                    </button>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>Not:</strong> Bu sistem genel sağlık bilgisi sağlar. Acil durumlarda 112'yi arayın veya en yakın hastaneye gidin.
        </div>
    </div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function askQuestion() {
        const question = $('#questionInput').val().trim();
        if (!question) {
            alert('Lütfen bir soru girin');
            return;
        }

        // Add user message to chat
        $('#chatContainer').append(`
            <div class="mb-3">
                <div class="bg-light p-3 rounded">
                    <strong>Siz:</strong> ${question}
                </div>
                <div class="bg-primary bg-opacity-10 p-3 rounded mt-2">
                    <strong>AI:</strong> <span class="spinner-border spinner-border-sm"></span> Düşünüyorum...
                </div>
            </div>
        `);

        $('#questionInput').val('');
        $('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);

        $.ajax({
            url: '@Url.Action("AskQuestion")',
            type: 'POST',
            data: { question: question },
            success: function(result) {
                if (result.success) {
                    location.reload();
                } else {
                    alert('Hata: ' + result.message);
                }
            },
            error: function() {
                alert('Bir hata oluştu');
            }
        });
    }

    $('#questionInput').keypress(function(e) {
        if (e.which === 13) {
            askQuestion();
        }
    });
</script>

