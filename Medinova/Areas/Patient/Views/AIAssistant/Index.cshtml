@model IEnumerable<Medinova.Models.AIConversation>
@{
    ViewBag.Title = "AI Asistan";
    Layout = "~/Areas/Patient/Views/Shared/_PatientLayout.cshtml";
}

<div class="max-w-5xl mx-auto h-[calc(100vh-8rem)] flex flex-col">

    <!-- Header -->
    <div class="mb-4">
        <h2 class="text-2xl font-bold text-navy flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">smart_toy</span>
            AI Sağlık Asistanı
        </h2>
        <p class="text-sm text-navy/60 mt-1">
            Şikayetinizi yazın, genel sağlık önerileri alın.
        </p>
    </div>

    <!-- Chat Area -->
    <div id="chatContainer"
         class="flex-1 overflow-y-auto rounded-xl bg-white border border-slate-200 p-6 space-y-6">

        @if (Model != null && Model.Any())
        {
            foreach (var conv in Model.OrderBy(c => c.CreatedDate))
            {
                <!-- User -->
                <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-xl rounded-br-sm bg-primary text-white px-4 py-3">
                        @Html.Raw(HttpUtility.HtmlEncode(conv.UserMessage).Replace("\n", "<br/>"))
                        <div class="mt-1 text-[11px] text-white/70 text-right">
                            Siz · @conv.CreatedDate?.ToString("HH:mm")
                        </div>
                    </div>
                </div>

                <!-- AI -->
                <div class="flex justify-start gap-3">
                    <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-[20px]">smart_toy</span>
                    </div>
                    <div class="max-w-[70%] rounded-xl rounded-bl-sm bg-background-light px-4 py-3 text-[15px]">
                        @Html.Raw(HttpUtility.HtmlEncode(conv.AIResponse).Replace("\n", "<br/>"))
                        <div class="mt-1 text-[11px] text-navy/50">
                            AI Asistan · @conv.CreatedDate?.ToString("HH:mm")
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="h-full flex items-center justify-center text-center text-navy/50">
                <div>
                    <span class="material-symbols-outlined text-4xl mb-2">forum</span>
                    <p class="text-sm">
                        Henüz sohbet yok.<br />
                        Aşağıdan sorunuzu yazabilirsiniz.
                    </p>
                </div>
            </div>
        }
    </div>

    <!-- Error -->
    <div id="errorBox"
         class="hidden mt-3 rounded-lg bg-red-50 border border-red-200 px-4 py-2 text-sm text-red-700">
    </div>

    <!-- Input -->
    <div class="mt-4 flex items-end gap-3">
        <textarea id="questionInput"
                  rows="1"
                  placeholder="Sorunuzu yazın… (Enter: Gönder, Shift+Enter: Yeni satır)"
                  class="flex-1 resize-none rounded-xl border border-slate-300 px-4 py-3
                         focus:outline-none focus:ring-2 focus:ring-primary/40 text-sm"></textarea>

        <button onclick="askQuestion()"
                class="flex items-center gap-2 rounded-xl bg-primary px-5 py-3
                       text-white font-semibold hover:bg-primary/90 transition">
            <span class="material-symbols-outlined text-[20px]">send</span>
            Gönder
        </button>
    </div>

    <!-- Info -->
    <div class="mt-3 text-[12px] text-navy/60">
        Bu sistem yalnızca bilgilendirme amaçlıdır. Acil durumlarda <strong>112</strong>’yi arayın.
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function cleanText(text) {
        if (!text) return '';
        return $('<div>').text(text).html()
            .replace(/\*\*(.*?)\*\*/g, '$1')
            .replace(/\*(.*?)\*/g, '$1')
            .replace(/\n{3,}/g, '\n\n')
            .replace(/\n/g, '<br>');
    }

    function scrollBottom() {
        const el = document.getElementById('chatContainer');
        el.scrollTop = el.scrollHeight;
    }

    function showError(msg) {
        $('#errorBox').text(msg).removeClass('hidden');
        setTimeout(() => $('#errorBox').addClass('hidden'), 4000);
    }

    function appendTyping() {
        $('#chatContainer').append(`
            <div id="typing" class="flex justify-start gap-3">
                <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                    <span class="material-symbols-outlined text-primary text-[20px]">smart_toy</span>
                </div>
                <div class="rounded-xl bg-background-light px-4 py-3 text-sm text-navy/60">
                    Yazıyor<span class="animate-pulse">...</span>
                </div>
            </div>
        `);
        scrollBottom();
    }

    function askQuestion() {
        const input = $('#questionInput');
        const text = input.val().trim();
        if (!text) {
            showError('Lütfen bir soru girin.');
            return;
        }

        $('#chatContainer').append(`
            <div class="flex justify-end">
                <div class="max-w-[70%] rounded-xl rounded-br-sm bg-primary text-white px-4 py-3">
                    ${cleanText(text)}
                    <div class="mt-1 text-[11px] text-white/70 text-right">Siz · şimdi</div>
                </div>
            </div>
        `);

        input.val('');
        appendTyping();
        scrollBottom();

        $.post('@Url.Action("AskQuestion")', { question: text })
            .done(res => {
                $('#typing').remove();
                if (res.success) {
                    $('#chatContainer').append(`
                        <div class="flex justify-start gap-3">
                            <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary text-[20px]">smart_toy</span>
                            </div>
                            <div class="max-w-[70%] rounded-xl rounded-bl-sm bg-background-light px-4 py-3 text-sm">
                                ${cleanText(res.response)}
                                <div class="mt-1 text-[11px] text-navy/50">AI Asistan · şimdi</div>
                            </div>
                        </div>
                    `);
                } else {
                    showError(res.message || 'Yanıt alınamadı.');
                }
                scrollBottom();
            })
            .fail(() => {
                $('#typing').remove();
                showError('Sunucuya ulaşılamadı.');
            });
    }

    $('#questionInput').on('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            askQuestion();
        }
    });

    $(document).ready(scrollBottom);
</script>
