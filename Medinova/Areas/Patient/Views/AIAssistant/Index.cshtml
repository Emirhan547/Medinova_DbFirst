@model IEnumerable<Medinova.Models.AIConversation>
@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Patient/Views/Shared/_PatientLayout.cshtml";
}

<div class="container-fluid py-4">
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI Sağlık Asistanı
                </h4>
            </div>
            <div class="card-body" style="height: 500px; overflow-y: auto;" id="chatContainer">
                @if (Model.Any())
                {
                    foreach (var conv in Model.OrderBy(c => c.CreatedDate))
                    {
                        <div class="mb-3">
                            <div class="bg-light p-3 rounded">
                                <strong>Siz:</strong> @conv.UserMessage
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded mt-2">
                                <strong>AI:</strong> @conv.AIResponse
                            </div>
                            <small class="text-muted">
                                @(conv.CreatedDate.HasValue
        ? conv.CreatedDate.Value.ToString("dd MMM HH:mm")
        : "")
                            </small>

                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Henüz sohbet başlatılmadı. Aşağıdaki kutuya sorunuzu yazın.</p>
                    </div>
                }
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="questionInput" class="form-control"
                           placeholder="Sorunuzu yazın... (örn: Boynum ağrıyor ne yapabilirim?)">
                    <button class="btn btn-primary" onclick="askQuestion()">
                        <i class="fas fa-paper-plane"></i> Gönder
                    </button>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle"></i>
            <strong>Not:</strong> Bu sistem genel sağlık bilgisi sağlar. Acil durumlarda 112'yi arayın veya en yakın hastaneye gidin.
        </div>
    </div>
</div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="chatErrorToast" class="toast text-bg-danger" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-triangle-exclamation me-2 text-danger"></i>
            <strong class="me-auto">Hata</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="chatErrorToastBody"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function showErrorToast(message) {
        const toastBody = $('#chatErrorToastBody');
        toastBody.text(message);
        const toastEl = document.getElementById('chatErrorToast');
        if (window.bootstrap && toastEl) {
            const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
            toast.show();
        } else {
            alert(message);
        }
    }

    function formatResponseText(text) {
        const escaped = $('<div>').text(text).html();
        return escaped.replace(/\n/g, '<br>');
    }

    function askQuestion() {
        const question = $('#questionInput').val().trim();
        if (!question) {
          
            showErrorToast('Lütfen bir soru girin.');
            return;
        }

        // Add user message to chat
        $('#chatContainer .text-center').remove();
        $('#chatContainer').append(`
          
            <div class="mb-3 chat-message">
                <div class="bg-light p-3 rounded">
                    <strong>Siz:</strong> ${question}
                </div>
                <div class="bg-primary bg-opacity-10 p-3 rounded mt-2">
                    
                    <strong>AI:</strong> <span class="ai-response-text"><span class="spinner-border spinner-border-sm"></span> Düşünüyorum...</span>
                </div>
            </div>
        `);

        $('#questionInput').val('');
        $('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);

        $.ajax({
            url: '@Url.Action("AskQuestion")',
            type: 'POST',
            data: { question: question },
            success: function(result) {
                const latestMessage = $('#chatContainer .chat-message').last().find('.ai-response-text');
                if (result.success) {
               
                    latestMessage.html(formatResponseText(result.response || 'Yanıt alınamadı.'));
                } else {
                 
                    latestMessage.text('Yanıt alınamadı.');
                    showErrorToast(result.message || 'AI yanıtı alınırken bir hata oluştu.');
                }
                $('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);
            },
            error: function() {
               
                $('#chatContainer .chat-message').last().find('.ai-response-text').text('Yanıt alınamadı.');
                showErrorToast('Sunucuya ulaşılamadı. Lütfen bağlantınızı kontrol edip tekrar deneyin.');
                $('#chatContainer').scrollTop($('#chatContainer')[0].scrollHeight);
            }
        });
    }

    $('#questionInput').keypress(function(e) {
        if (e.which === 13) {
            askQuestion();
        }
    });
</script>

