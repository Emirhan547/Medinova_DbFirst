@using System.Collections.Generic
@using System.Linq
@model IEnumerable<dynamic>
@{
    ViewBag.Title = "ML Predictions";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var predictions = Model?.ToList() ?? new List<dynamic>();
    var maxTotal = predictions.Any() ? predictions.Max(item => Convert.ToDouble(item.TotalPredicted)) : 0d;
}

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white">ML Predictions</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-1">Monthly appointment forecast summary</p>
        </div>
        <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 dark:border-slate-700 px-4 py-2 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800"
           href="@Url.Action("Index", "Dashboard", new { area = "Admin" })">
            <span class="material-symbols-outlined !text-lg">arrow_back</span>
            Dashboard
        </a>
    </div>

    @if (predictions.Any())
    {
        <div class="bg-white dark:bg-background-dark rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-lg font-bold text-slate-900 dark:text-white">Mini Chart</h2>
                    <p class="text-sm text-slate-400">Predicted appointment totals by month</p>
                </div>
                <span class="text-xs font-semibold uppercase tracking-widest text-slate-400">Last 3 months</span>
            </div>
            <div class="flex items-end gap-4 h-40">
                @foreach (var item in predictions)
                {
                    var total = Convert.ToDouble(item.TotalPredicted);
                    var height = maxTotal > 0 ? Math.Round((total / maxTotal) * 100, 2) : 0;
                    <div class="flex flex-col items-center gap-2 flex-1">
                        <div class="w-full h-28 bg-slate-100 dark:bg-slate-800 rounded-lg flex items-end overflow-hidden">
                            <div class="w-full bg-primary rounded-lg" style="height: @(height)%"></div>
                        </div>
                        <span class="text-xs font-semibold text-slate-500 dark:text-slate-400">@item.Month</span>
                    </div>
                }
            </div>
        </div>

        <div class="bg-white dark:bg-background-dark rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-800">
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Monthly Predictions Table</h2>
                <p class="text-sm text-slate-400">Totals and confidence scores</p>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">
                        <tr>
                            <th class="px-6 py-4">Month</th>
                            <th class="px-6 py-4">Total Predicted</th>
                            <th class="px-6 py-4">Avg Confidence</th>
                            <th class="px-6 py-4">Trend</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                        @foreach (var item in predictions)
                        {
                            var total = Convert.ToDouble(item.TotalPredicted);
                            var confidence = Convert.ToDouble(item.AvgConfidence);
                            var width = maxTotal > 0 ? Math.Round((total / maxTotal) * 100, 2) : 0;
                            var confidenceClass = confidence >= 80 ? "text-emerald-600 dark:text-emerald-400" : confidence >= 60 ? "text-amber-600 dark:text-amber-400" : "text-red-600 dark:text-red-400";
                            <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                                <td class="px-6 py-4 text-sm font-semibold text-slate-900 dark:text-white">@item.Month</td>
                                <td class="px-6 py-4 text-sm text-slate-600 dark:text-slate-300">@total.ToString("N0")</td>
                                <td class="px-6 py-4 text-sm font-semibold @confidenceClass">@confidence.ToString("0.##")%</td>
                                <td class="px-6 py-4">
                                    <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-primary rounded-full" style="width: @(width)%"></div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="bg-white dark:bg-background-dark rounded-xl border border-slate-200 dark:border-slate-800 p-12 text-center">
            <span class="material-symbols-outlined !text-5xl text-slate-300 dark:text-slate-600 mb-4">monitoring</span>
            <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-2">No Predictions Available</h3>
            <p class="text-slate-500 dark:text-slate-400">Generate predictions once there is enough appointment history.</p>
        </div>
    }
</div>